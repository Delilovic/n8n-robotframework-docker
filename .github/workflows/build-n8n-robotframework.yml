name: Build n8n Robot Framework Images

on:
  workflow_dispatch:
    inputs:
      node_version:
        description: 'Node.js version'
        required: true
        default: '22.22.0'
        type: string
      n8n_version:
        description: 'n8n version'
        required: true
        default: '2.4.4'
        type: string

env:
  DOCKERHUB_USERNAME: delilovic

jobs:
  build-n8n-base:
    name: Build n8n_base
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push n8n_base
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/images/n8n-base/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            NODE_VERSION=${{ inputs.node_version }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n_base:${{ inputs.node_version }}-bookworm-slim

  build-n8n:
    name: Build n8n
    runs-on: ubuntu-latest
    needs: build-n8n-base
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push n8n
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/images/n8n/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            NODE_VERSION=${{ inputs.node_version }}
            N8N_VERSION=${{ inputs.n8n_version }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n:${{ inputs.n8n_version }}-bookworm-slim
            ${{ env.DOCKERHUB_USERNAME }}/n8n:latest

  build-n8n-robotframework:
    name: Build n8n-robotframework
    runs-on: ubuntu-latest
    needs: build-n8n
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push n8n-robotframework
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/images/n8n-robotframework/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            N8N_VERSION=${{ inputs.n8n_version }}
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/n8n_robotframework:${{ inputs.n8n_version }}-bookworm-slim
            ${{ env.DOCKERHUB_USERNAME }}/n8n_robotframework:latest
